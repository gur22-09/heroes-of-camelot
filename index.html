<!DOCTYPE html>
<html>
<head>
  <title>Heroes of Camelot</title>
  <meta name="viewport" content="user-scalable=no, width=device-width, initial-scale=1, maximum-scale=1">
  <meta name="apple-mobile-web-app-capable" content="yes" />
  <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent" />
  <style>
  .skill, .card { display: inline-block; padding-right: 5px; }
  .skill:after, .card:after { content: ','; }
  .skill:last-child:after, .card:last-child:after { content: ''; }
  .skill .hover, .card .hover { position: absolute; z-index: 1; background-color: #68a; padding: 5px; }
  img { width: 400px; height: 300px; }
  td.image { position: relative; }
  .skill-box { width: 50px; height: 51px; display: inline-block; position: absolute; border: 1px solid red; border-radius: 50%; bottom: 9px; }
  .skill-box1 { left: 20px; } .skill-box2 { left: 74px; } .skill-box3 { left: 128px; } .skill-box4 { left: 182px; } .skill-box5 { left: 236px; } .skill-box6 { left: 290px; } .skill-box7 { left: 344px; }
  </style>
  <script src="jquery.min.js"></script>
  <script src="angular.min.js"></script>
  <script src="angular-route.js"></script>
  <link rel="stylesheet" type="text/css" href="bootstrap.css">
  <script src="bootstrap.min.js"></script>
  <script src="tabletop.min.js"></script>
  <script>
  function logEvent(category, action, label, value){
    if (typeof(ga) != 'undefined') {
      ga('send', 'event', category, action, label, value)
    } else {
      console.log('send', 'event', category, action, label, value)
    }
  }
  function Card(name, clazz, stars, mana, maxlevel, hp, atk, skills){
    this.name   = name
    this.clazz  = clazz
    this.stars  = stars
    this.mana   = mana
    this.maxlevel = maxlevel
    this.hp     = hp
    this.atk    = atk
    this.skills = skills
  }
  function Skill(name, description, cards){
    this.name        = name
    this.description = description
    this.cards       = cards
  }
  function checkvisible(element) {
    if (!element.is(':visible')) return false
    var vpH = $(window).height(), // Viewport Height
        st = $(window).scrollTop(), // Scroll Top
        sb = st + vpH, // Scroll Bottom
        t = element.offset().top,
        b = t + element.height();
    // console.log(vpH, st, sb, t, b, (st <= b && t <= sb))
    return st <= b && t <= sb;
  }

  app = angular.module("myApp", ['ngRoute'])
  app.config(function($routeProvider, $locationProvider) {
    $locationProvider.html5Mode(false)
    $routeProvider
      .when('/', { templateUrl: 'main.html' })
      // .when('/cards/:cardId', { templateUrl: 'card.html' })
      .otherwise({redirectTo: '/'})
  })
  app.filter('limit', function() {
    return function(input, all) {
      if (all || !input) return input
      return input.slice(0, 20)
    }
  })
  app.directive('lazyload', function($document) {
    return function(scope, element, attr){
      function onScroll(e){
        if (checkvisible(element)) {
          element.attr('src', element.attr('lazyload'))
        } else {
          element.attr('src', 'placeholder.png')
        }
      }
      $document.on('scroll', onScroll)
      scope.$watch(function(){ return checkvisible(element) }, function(visible){
        if (visible) {
          element.attr('src', element.attr('lazyload'))
        } else {
          element.attr('src', 'placeholder.png')
        }
      })
    }
  })
  app.controller('AppController', ['$scope', function(scope){
    scope.search = ''
    scope.show_all_cards = false
    scope.currentTab = 'cards'

    scope.hovers = {}
    scope.mouseenterSkill = function(card, skill){
      scope.hovers[card.name + skill] = true
      logEvent('skill', 'hover', skill)
    }
    scope.mouseleaveSkill = function(card, skill){
      scope.hovers[card.name + skill] = false
    }
    scope.isSkillHovered = function(card, skill){
      return scope.hovers[card.name + skill]
    }
    scope.mouseenterCard = function(skill, card){
      scope.hovers[skill.name + card] = true
      logEvent('card', 'hover', card)
    }
    scope.mouseleaveCard = function(skill, card){
      scope.hovers[skill.name + card] = false
    }
    scope.isCardHovered = function(skill, card){
      return scope.hovers[skill.name + card]
    }
    scope.showTab = function(tab){
      scope.currentTab = tab
      logEvent('tab', 'click', tab)
    }
    scope.isTabVisible = function(tab){
      return scope.currentTab == tab
    }
    function updateCards(data, tabletop) {
      // console.log(data)
      scope.$apply(function(){
        scope.cards = []
        for(var i in data.elements){
          var obj = data.elements[i]
          var skills = []
          for(var j = 1; j <= 7; j++){
            var skill = obj['skill' + j]
            if (skill && skill != '-') {
              skills.push(skill)
            }
          }
          var card = new Card(obj.name, obj.class, obj.stars, obj.mana, obj.maxlevel, obj.hp, obj.atk, skills)
          scope.cards.push(card)
        }
      })
    }
    function updateSkills(data, tabletop){
      // console.log(data)
      scope.$apply(function(){
        scope.skills = []
        for(var i in data.elements){
          var obj = data.elements[i]
          var cards = []
          for(var j = 1; j <= 4; j++){
            var card = obj['card' + j]
            if (card) {
              cards.push(card)
            }
          }
          var skill = new Skill(obj.name, obj.description, cards)
          scope.skills.push(skill)
        }
      })
    }
    Tabletop.init( { key: '0AgrwVCi0Zp_LdHF0d1Y5R3NRTXFtZk1rUjJaUEI2dUE',
                     callback: function(data, tabletop){
                       updateCards(data.Cards, tabletop)
                       updateSkills(data.Skills, tabletop)
                     },
                   simpleSheet: false } )
  }])
  </script>
</head>

<body ng-controller="AppController">
  <div ng-view></div>
  <script type="text/ng-template" id="main.html">
    <form class="form-horizontal">
      <div class="form-group">
        <label for="search" class="col-sm-2 control-label">Search</label>
        <div class="col-sm-10">
          <input id="search" autofocus class="form-control" ng-model="search">
        </div>
      </div>
      <div class="form-group">
        <div class="col-sm-10 col-sm-offset-2">
          <div class="checkbox">
            <label>
              <input type="checkbox" ng-model="show_all_cards">
              Show all cards and all skills (might be slow)
            </label>
          </div>
        </div>
      </div>
    </form>

    <!-- Nav tabs -->
    <ul class="nav nav-tabs">
      <li class="active" ng-class="{active: isTabVisible('cards')}"><a href ng-click="showTab('cards')">Cards</a></li>
      <li ng-class="{active: isTabVisible('skills')}"><a href ng-click="showTab('skills')">Skills</a></li>
    </ul>

    <!-- Tab panes -->
    <div class="tab-content">
      <div class="tab-pane active" id="cards" ng-class="{active: isTabVisible('cards')}" ng-show="isTabVisible('cards')">
        <table class="cards table table-hover table-striped">
          <thead>
            <tr>
              <th>Name</th>
              <th>Class</th>
              <th>Stars</th>
              <th>Mana</th>
              <th>Max level</th>
              <th>HP</th>
              <th>ATK</th>
              <th>Skill combos</th>
              <th>Image</th>
            </tr>
          </thead>
          <tr ng-repeat="card in cards | filter:search | limit:show_all_cards">
            <td>{{card.name}}</td>
            <td>{{card.clazz}}</td>
            <td>{{card.stars}}</td>
            <td>{{card.mana}}</td>
            <td>{{card.maxlevel}}</td>
            <td>{{card.hp}}</td>
            <td>{{card.atk}}</td>
            <td><div class="skill" ng-repeat="skill in card.skills" ng-mouseenter="mouseenterSkill(card, skill)" ng-mouseleave="mouseleaveSkill(card, skill)">{{skill}}<div class="hover" ng-if="isSkillHovered(card, skill)"><img ng-src="skills/{{skill}}.jpg"></div></div></td>
            <td class="image"><img src="placeholder.png" lazyload="cards/{{card.name}}.jpg"><div ng-repeat="skill in card.skills" class="skill-box skill-box{{$index+1}}"></div></td>
          </tr>
        </table>
      </div>
      <div class="tab-pane" id="skills" ng-class="{active: isTabVisible('skills')}" ng-show="isTabVisible('skills')">
        <table class="skills table table-hover table-striped">
          <thead>
            <tr>
              <th>Name</th>
              <th>Description</th>
              <th>Cards</th>
              <th>Image</th>
            </tr>
          </thead>
          <tr ng-repeat="skill in skills | filter:search | limit:show_all_cards">
            <td>{{skill.name}}</td>
            <td>{{skill.description}}</td>
            <td><div class="card" ng-repeat="card in skill.cards" ng-mouseenter="mouseenterCard(skill, card)" ng-mouseleave="mouseleaveCard(skill, card)">{{card}}<div class="hover" ng-if="isCardHovered(skill, card)"><img ng-src="cards/{{card}}.jpg"></div></div></td>
            <td class="image"><img src="placeholder.png" lazyload="skills/{{skill.name}}.jpg"><div ng-repeat="card in skill.cards" class="card-box card-box{{$index+1}}"></div></td>
          </tr>
        </table>
      </div>
    </div>
  </script>
  <script type="text/javascript">
  angular.bootstrap(document, ['myApp'])
  </script>
  <script>
    (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
    (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
    m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
    })(window,document,'script','//www.google-analytics.com/analytics.js','ga');
    ga('create', 'UA-48535839-2', 'sullerandras.github.io');
    ga('send', 'pageview');
  </script>
</body>
</html>
